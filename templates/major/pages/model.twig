{% extends 'app.twig' %}
{% block MAIN %}
    {% set price = resource['car-price'] | number_format %}
    {% set oldprice = runSnippet('helpers', {caroldprice: price,
        action:'caroldprice'}) %}
    {% set vigoda = oldprice - price %}
    {% set configuration_id = runSnippet('DocLister', {
        id: resource.id, tvList: 'configuration_id', display: 1, tpl: '@CODE:[+tv.configuration_id+]'} ) %}

    {% set photos = resource['colors_list'] | json %}

    {% set photo = "" %}
    {% for i in 0..10 %}
        {% if not photo and photos['Color#' ~ i]['items']['image']['value'] %}
            {% set photo = photos['Color#' ~ i]['items']['image']['value'] %}
        {% endif %}
    {% endfor %}

    {% set modifications = resource['car_modifications'] | json %}

    {% set cars = runSnippet("DocLister", {
        api: 1,
        parents: resource.id,
        addWhereList: "c.template = 28",
        tvList:'car-price,old-car-price,car_photos,run,configuration_id,engine_power,gear,year, image,mark_id,model_id',
    }) | json %}
    {% set prices = cars | column('tv_car-price') | default([0]) %}

    <div class="index-page-slider text-light">
        <div class="item other"
             style="background-image: url('{{ photo }}');background-position: center;background-repeat: no-repeat;background-size: contain;width: 100%;">
            <div class="container">
                <div class="top-text mt-3 mb-3">
                </div>
                <div class="text model__header--title">
                    {{ runSnippet ('DocInfo', {docid: resource.parent, field:pagetitle}) |raw }} {{ resource.pagetitle }}
                </div>
            </div>
        </div>
    </div>
    {% include '/partials/crumbs.twig' %}
    <div class="item-page pb-5">
        <div class="container position-relative">
            <img style="width: 300px; height: auto" src="" class="logo position-absolute">
            <h1 class="mb-2"> {{ runSnippet ('DocInfo', {docid: resource.parent, field:pagetitle}) |raw }} {{ resource.pagetitle }}
            </h1>
            <div class="top-text mb-4">
                Успешная модель, которая стала еще лучше
            </div>
            <div class="top-info mb-4 w-100">
                <div class="image text-center">
                    <img src="{{ photo | raw }}">
                </div>
                <div class="text">
                    <div class="name mb-3">
                        {{ runSnippet ('DocInfo', {docid: resource.parent, field:pagetitle}) |raw }} {{ resource.pagetitle }}
                    </div>
                    <span class="items text-light mb-3 py-2 px-3 d-inline-block bg-dark">Автомобилей: {{ cars | count }}</span> <br/>
                    <span class="price d-inline-block py-2 px-3">от {{ min(prices) | number_format(0, '', ' ') }} ₽</span>
                </div>
            </div>

            <div class="modifications-block pb-2">
                {% for modificationKey, modification in modifications %}
                    {% set modificationKey = modificationKey | replace({'#': "-"}) %}

                    {% set modificationTitle = modification["value"] %}
                    {% if modificationTitle is empty %}
                        {% set modificationTitle = "Мод. " ~ loop.index %}
                    {% endif %}

                    {% for modificationItemKey, modificationItem in modification['items'] %}
                        {% if "ModificationItem" in modificationItemKey %}
                            {% set modificationKey = modificationKey ~ "-" ~ modificationItemKey | replace({'#': "-"}) %}

                            {% set modificationItemTitle = modificationTitle ~ ": " ~ modificationItem['value'] %}

                            <h3 class="mb-3">{{ modificationItemTitle }}</h3>
                            <div class="item mb-2">
                                <div class="item-name flex">
                                    <div class="name" type="button" data-toggle="collapse"
                                         data-target="#id_{{ modificationKey }}" aria-expanded="false"
                                         aria-controls="id_{{ modificationKey }}" style="word-break: break-word;     max-width: 170px;
">
                                        {{ modificationItem['value'] }}
                                    </div>
                                    <div class="price">
                                        <span class="old">
                                            -
                                        </span>
                                        <span class="new">
                                            {{ modificationItem['items']['price']['value'] }}
                                        </span>
                                    </div>
                                    <div class="buttons">
                                        <button class="scroll-btn" data-fancybox="" data-src="#popupCredNew">В кредит
                                            за {{ (modx.runSnippet("toInt", { value: modificationItem['items']['price']['value'] }) / 82) | round | number_format(0, '.', ' ') }}
                                             ₽/мес.
                                        </button>
                                        <button data-fancybox="" data-src="#popupCredNew">Trade-in</button>
                                        <button data-fancybox="" data-src="#popupCredNew">Забронировать</button>
                                    </div>
                                </div>
                                <div class="item-content collapse" id="id_{{ modificationKey }}">
                                    {% for modificationItemOptionKey, modificationItemOption in modificationItem['items'] %}
                                        {% if "ModificationItemOption" in modificationItemOptionKey %}
                                            <div class="card-header">{{ modificationItemOption['value'] }}</div>
                                            <div class="card-body">
                                                {{ modificationItemOption['items']['content']['value'] | raw }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>

            <div class="index-catalog-block2 pb-5">
                <div class="container">
                    <div class="list row" id="catalog">
                        {% if cars %}
                            {% for car in cars %}
                                {% set car_photos = car['tv_car_photos'] | json %}
                                {% set car_photos = car_photos.fieldValue %}
                                {% set car_photo = car_photos[0]['image'] %}

                                <div class="item col-12 col-sm-3 position-relative mb-3 "><a href="{{ car['url'] }}">
                                        <span class="hit position-absolute py-1 px-3">HIT</span>
                                        <div class="image">
                                            <img src="{{ car_photo }}">
                                        </div>
                                        <div class="p-3">
                                            <a href="{{ car['url'] }}"
                                               class="name d-block mb-2">{{ runSnippet ('DocInfo', {docid:car.parent, field:pagetitle}) | raw }} {{ car['title'] }} </a>
                                            <div class="row data text-center">

                                            </div>
                                            <div class="price mb-3">
                                                {% if car["tv_old-car-price"] | number_format(0, '', ' ') %}
                                                    <span class="old d-inline-block mb-1">
                                                        {{ car["tv_old-car-price"] | number_format(0, '', ' ') }} ₽
                                                    </span>
                                                {% endif %}

                                                {% if car["tv_car-price"] | number_format(0, '', ' ') %}
                                                    <div class="new">
                                                        {{ car["tv_car-price"] | number_format(0, '', ' ') }} ₽
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="buttons">
                                                <button data-fancybox="" data-src="#popupCredNew" class="w-100 mb-2">В кредит от 4,9%</button>
                                                <button data-fancybox="" data-src="#popupCredNew" class="w-100 mb-2">Забронировать</button>
                                                <button class="w-100" onclick="location.href='{{ car.url }}';">Подробнее</button>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="container">
                                <div class="row">
                                    <div class="col text-center">
                                        <h2 class="display-4 catalog-block h2">По вашим критериям А/М не найдены, попробуйте немного изменить условия поиска</h2>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page-form-block mb-5">
        <div class="container">
            {{ runSnippet('Form', {
                formid: 'FormCallback',
                path: '/templates/major/partials/forms/feedback/',
                extension: 'twig'
            }) | raw }}
        </div>
    </div>

    <script>
      function scrollToForm () {
        var form = document.getElementById('FormCallback')
        form.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' })
      }

    </script>
    {{ runSnippet('takemodels', {configuration_id: resource['configuration_id'] }) }}
    {% set minam = price / 10 %}
    {% set maxam = price %}
{% endblock %}
